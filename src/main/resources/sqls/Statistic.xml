<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lotte.admin.dao.StatisticDao">

    <select id="selectProductCountByCategory" resultType="com.lotte.admin.dto.ProductCategoryDto">
        SELECT c.category_name AS categoryName, COUNT(c.category_name) AS cnt, SUM(cart_item_total_price) AS total
        FROM categories c, cart_items cart, products p
        WHERE p.product_no = cart.product_no
          AND c.category_no = p.category_no
        GROUP BY c.category_name;
    </select>
    <select id="selectPricesByGender" resultType="com.lotte.admin.dto.UserGenderDto">
        SELECT u.user_gender AS userGender, COUNT(*) AS cnt, SUM(o.order_total_price) AS total
        FROM users u, orders o
        WHERE u.user_no = o.user_no
        GROUP BY user_gender
    </select>
    <select id="selectPricesByAge" resultType="com.lotte.admin.dto.UserAgeDto">
        SELECT
            CASE
                WHEN TIMESTAMPDIFF(YEAR, user_birth, now()) BETWEEN 0 AND 10 THEN '0'
                WHEN TIMESTAMPDIFF(YEAR, user_birth, now()) BETWEEN 10 AND 20 THEN '10'
                WHEN TIMESTAMPDIFF(YEAR, user_birth, now()) BETWEEN 20 AND 30 THEN '20'
                WHEN TIMESTAMPDIFF(YEAR, user_birth, now()) BETWEEN 30 AND 40 THEN '30'
                WHEN TIMESTAMPDIFF(YEAR, user_birth, now()) BETWEEN 40 AND 50 THEN '40'
                WHEN TIMESTAMPDIFF(YEAR, user_birth, now()) BETWEEN 50 AND 60 THEN '50'
                ELSE '60'
                END AS userAge,
            COUNT(*) AS cnt,
            SUM(o.order_total_price) AS total
        FROM users u, orders o
        WHERE u.user_no = o.user_no
        GROUP BY userAge
    </select>
    <select id="selectUsersByUserGrade" resultType="com.lotte.admin.dto.UserGradeDto">
        SELECT user_grade AS userGrade, COUNT(*) AS cnt
        FROM users
        GROUP BY user_grade
    </select>
    <select id="selectTotalByDate" resultType="com.lotte.admin.dto.TotalOrderDto">
        SELECT DATE_FORMAT(created_at, '%Y년%m월%d일') AS created_at, order_state, COUNT(*) AS cnt, SUM(order_total_price) AS total
        FROM orders
        GROUP BY DATE_FORMAT(created_at, '%Y년%m월%d일')
    </select>
    <select id="selectTotalByYear" resultType="com.lotte.admin.dto.TotalOrderDto">
        SELECT DATE_FORMAT(created_at, '%Y') AS created_at, order_state, COUNT(*) AS cnt, SUM(order_total_price) AS total
        FROM orders
        GROUP BY DATE_FORMAT(created_at, '%Y')
        HAVING created_at = DATE_FORMAT(NOW(), '%Y')
    </select>
    <select id="selectTotalByMonth" resultType="com.lotte.admin.dto.TotalOrderDto">
        SELECT DATE_FORMAT(created_at, '%m') AS created_at, order_state, COUNT(*) AS cnt, SUM(order_total_price) AS total
        FROM orders
        GROUP BY DATE_FORMAT(created_at, '%m')
        HAVING created_at = DATE_FORMAT(NOW(), '%m')
    </select>
</mapper>